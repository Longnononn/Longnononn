-- Dead Rail Script by Long dzz
-- Includes: Speed, Noclip, AutoPickup, AutoAim, ESP Zombie

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local hrp = character:WaitForChild("HumanoidRootPart")

-- Function to update character and humanoid on respawn
local function updateCharacter()
    character = player.Character or player.CharacterAdded:Wait()
    humanoid = character:WaitForChild("Humanoid")
    hrp = character:WaitForChild("HumanoidRootPart")
    -- Đảm bảo tốc độ được áp dụng lại nếu đang bật khi nhân vật hồi sinh
    if speedEnabled then
        humanoid.WalkSpeed = 30
    end
end

player.CharacterAdded:Connect(updateCharacter)

-- GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "DeadRailUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- Credit Label
local creditLabel = Instance.new("TextLabel")
creditLabel.Size = UDim2.new(0, 160, 0, 25)
creditLabel.Position = UDim2.new(0, 10, 0, 10)
creditLabel.BackgroundTransparency = 1
creditLabel.Text = "script by Long dzz"
creditLabel.TextColor3 = Color3.new(1, 1, 1)
creditLabel.Font = Enum.Font.Gotham
creditLabel.TextScaled = true
creditLabel.Parent = screenGui

-- Toggle GUI
local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(0, 40, 0, 40)
toggleBtn.Position = UDim2.new(0, 10, 0, 45)
toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
toggleBtn.Text = "+"
toggleBtn.TextScaled = true
toggleBtn.TextColor3 = Color3.new(1, 1, 1)
toggleBtn.Font = Enum.Font.GothamBlack
toggleBtn.Parent = screenGui
Instance.new("UICorner", toggleBtn)

-- Main panel
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 160, 0, 130) -- Increased height for more buttons if needed later
mainFrame.Position = UDim2.new(0, 60, 0, 45)
mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
mainFrame.Visible = false
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame)

-- Speed button
local speedBtn = Instance.new("TextButton")
speedBtn.Size = UDim2.new(1, -20, 0, 30)
speedBtn.Position = UDim2.new(0, 10, 0, 10)
speedBtn.BackgroundColor3 = Color3.fromRGB(255, 150, 0)
speedBtn.Text = "Speed: OFF"
speedBtn.TextScaled = true
speedBtn.Font = Enum.Font.GothamBold
speedBtn.TextColor3 = Color3.new(1, 1, 1)
speedBtn.Parent = mainFrame
Instance.new("UICorner", speedBtn)

-- Noclip button
local noclipBtn = Instance.new("TextButton")
noclipBtn.Size = UDim2.new(1, -20, 0, 30)
noclipBtn.Position = UDim2.new(0, 10, 0, 50)
noclipBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 255)
noclipBtn.Text = "Noclip: OFF"
noclipBtn.TextScaled = true
noclipBtn.Font = Enum.Font.GothamBold
noclipBtn.TextColor3 = Color3.new(1, 1, 1)
noclipBtn.Parent = mainFrame
Instance.new("UICorner", noclipBtn)

-- Auto Aim button
local autoAimBtn = Instance.new("TextButton")
autoAimBtn.Size = UDim2.new(1, -20, 0, 30)
autoAimBtn.Position = UDim2.new(0, 10, 0, 90)
autoAimBtn.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
autoAimBtn.Text = "Auto Aim: OFF"
autoAimBtn.TextScaled = true
autoAimBtn.Font = Enum.Font.GothamBold
autoAimBtn.TextColor3 = Color3.new(1, 1, 1)
autoAimBtn.Parent = mainFrame
Instance.new("UICorner", autoAimBtn)


-- Toggle visibility
toggleBtn.MouseButton1Click:Connect(function()
	mainFrame.Visible = not mainFrame.Visible
end)

-- Feature toggles
local speedEnabled = false
local noclipEnabled = false
local autoAimEnabled = false -- New toggle for Auto Aim

speedBtn.MouseButton1Click:Connect(function()
	speedEnabled = not speedEnabled
	if humanoid then -- Ensure humanoid exists
		humanoid.WalkSpeed = speedEnabled and 30 or 16
	end
	speedBtn.Text = "Speed: " .. (speedEnabled and "ON" or "OFF")
	speedBtn.BackgroundColor3 = speedEnabled and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(255, 150, 0)
end)

noclipBtn.MouseButton1Click:Connect(function()
	noclipEnabled = not noclipEnabled
	noclipBtn.Text = "Noclip: " .. (noclipEnabled and "ON" or "OFF")
	noclipBtn.BackgroundColor3 = noclipEnabled and Color3.fromRGB(0, 200, 255) or Color3.fromRGB(150, 0, 255)
end)

autoAimBtn.MouseButton1Click:Connect(function()
    autoAimEnabled = not autoAimEnabled
    autoAimBtn.Text = "Auto Aim: " .. (autoAimEnabled and "ON" or "OFF")
    autoAimBtn.BackgroundColor3 = autoAimEnabled and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
end)


RunService.Stepped:Connect(function()
	if noclipEnabled and character then
        -- Only disable collisions for player's character parts
		for _, part in ipairs(character:GetDescendants()) do
			if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" and part.CanCollide then -- Only change if it's currently collidable
				part.CanCollide = false
			end
		end
	end
end)

-- Auto Pickup Items
spawn(function()
	while task.wait(0.1) do
		pcall(function()
            if not hrp then return end -- Ensure hrp exists
			for _, item in ipairs(Workspace:GetDescendants()) do
				if item:IsA("BasePart") and item.Name:lower():find("pickup") and (item.Position - hrp.Position).Magnitude < 10 then
					firetouchinterest(hrp, item, 0)
					task.wait()
					firetouchinterest(hrp, item, 1)
				end
			end
		end)
	end
end)

-- Auto Aim at Zombie
spawn(function()
	while task.wait(0.05) do -- Slightly faster update for smoother aim
		pcall(function()
            if not autoAimEnabled or not hrp or not humanoid then return end -- Check if enabled and hrp, humanoid exists

			local closest, dist = nil, 100 -- Limit range to 100 studs
			for _, obj in ipairs(Workspace:GetDescendants()) do
                -- Kiểm tra xem đó có phải là một model có Humanoid và không phải là nhân vật của người chơi
                if obj:IsA("Model") and obj:FindFirstChildOfClass("Humanoid") and obj ~= character then
                    local targetHumanoid = obj:FindFirstChildOfClass("Humanoid")
                    -- Chỉ nhắm mục tiêu nếu Humanoid còn sống
                    if targetHumanoid and targetHumanoid.Health > 0 then
                        local head = obj:FindFirstChild("Head") or obj:FindFirstChildWhichIsA("BasePart") -- Tìm bất kỳ BasePart nào nếu không có Head
                        if head and head:IsA("BasePart") then -- Ensure it's a valid part
                            local currentDist = (head.Position - hrp.Position).Magnitude
                            if currentDist < dist then
                                dist = currentDist
                                closest = head
                            end
                        end
                    end
				end
			end
			if closest then
                -- Xoay nhân vật một cách mượt mà trên mặt phẳng ngang
                local lookVector = (closest.Position - hrp.Position).Unit
                local targetCFrame = CFrame.lookAt(hrp.Position, hrp.Position + Vector3.new(lookVector.X, 0, lookVector.Z))
                hrp.CFrame = targetCFrame
			end
		end)
	end
end)

-- ESP for Zombie
local function createESP(part)
	if not part or not part:IsA("BasePart") or part:FindFirstChild("BoxESP") then return end
    -- Check if parent is a model and contains a humanoid (to ensure it's a character)
    if not part.Parent or not part.Parent:IsA("Model") or not part.Parent:FindFirstChildOfClass("Humanoid") then return end

	local box = Instance.new("BoxHandleAdornment")
	box.Name = "BoxESP"
	box.Adornee = part
	box.AlwaysOnTop = true
	box.ZIndex = 5
	box.Size = part.Size + Vector3.new(0.1, 0.1, 0.1)
	box.Color3 = Color3.fromRGB(255, 0, 0)
	box.Transparency = 0.4
	box.Parent = part
end

-- Initial scan for existing zombies
for _, obj in ipairs(Workspace:GetDescendants()) do
	if obj:IsA("Model") and obj:FindFirstChildOfClass("Humanoid") and obj ~= character then
		local head = obj:FindFirstChild("Head") or obj:FindFirstChildWhichIsA("BasePart")
		if head then
			createESP(head)
		end
	end
end

-- Connect to DescendantAdded for new zombies
Workspace.DescendantAdded:Connect(function(obj)
	if obj:IsA("Model") and obj:FindFirstChildOfClass("Humanoid") and obj ~= character then
		-- Give a small delay to ensure all parts are loaded
		task.wait(0.2)
		local head = obj:FindFirstChild("Head") or obj:FindFirstChildWhichIsA("BasePart")
		if head then
			createESP(head)
		end
	end
end)
