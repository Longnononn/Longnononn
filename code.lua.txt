local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local UIS = game:GetService("UserInputService")
local player = Players.LocalPlayer

local walkSpeedDefault = 16
local walkSpeedBoost = 28
local noclipEnabled = false
local speedEnabled = false
local autoStealEnabled = false -- Khôi phục autoStealEnabled

local stealRange = 15
local lastStealAttemptTime = 0 -- Đổi tên biến để rõ ràng hơn
local stealActionCooldown = 2 -- Thời gian chờ giữa các lần "cướp" toàn bộ (sau khi đã giữ xong)
local stealHoldDuration = 1.5 -- Thời gian mô phỏng "giữ nút" cho hành động cướp (tùy chỉnh)
local stealSignalInterval = 0.05 -- Tần suất gửi tín hiệu khi đang "giữ" nút (rất nhanh)

local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local hrp = character:WaitForChild("HumanoidRootPart")

-- GUI setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "SysCoreUI"
screenGui.ResetOnSpawn = false

screenGui.Parent = player

-- Credit label (luôn hiển thị)
local creditLabel = Instance.new("TextLabel")
creditLabel.Size = UDim2.new(0, 160, 0, 25)
creditLabel.Position = UDim2.new(0, 10, 0, 10)
creditLabel.BackgroundTransparency = 1
creditLabel.Text = "script by Long dzz"
creditLabel.TextColor3 = Color3.new(1, 1, 1)
creditLabel.Font = Enum.Font.Gotham
creditLabel.TextScaled = true
creditLabel.Parent = screenGui

-- Toggle button
local toggleGuiButton = Instance.new("TextButton")
toggleGuiButton.Size = UDim2.new(0, 40, 0, 40)
toggleGuiButton.Position = UDim2.new(0, 10, 0, 45)
toggleGuiButton.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
toggleGuiButton.Text = "+"
toggleGuiButton.TextScaled = true
toggleGuiButton.TextColor3 = Color3.new(1, 1, 1)
toggleGuiButton.BorderSizePixel = 0
toggleGuiButton.Font = Enum.Font.GothamBlack
toggleGuiButton.Parent = screenGui
Instance.new("UICorner", toggleGuiButton)

-- Main panel
local mainFrame = Instance.new("Frame")
-- Kích thước Y của frame điều chỉnh lại cho 3 nút
mainFrame.Size = UDim2.new(0, 160, 0, 130)
mainFrame.Position = UDim2.new(0, 60, 0, 45)
mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
mainFrame.Visible = false
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame)

-- Nút Speed + Noclip
local toggleSpeedNoclipBtn = Instance.new("TextButton")
toggleSpeedNoclipBtn.Size = UDim2.new(1, -20, 0, 30)
toggleSpeedNoclipBtn.Position = UDim2.new(0, 10, 0, 10)
toggleSpeedNoclipBtn.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
toggleSpeedNoclipBtn.Text = "Speed+Noclip: OFF"
toggleSpeedNoclipBtn.TextScaled = true
toggleSpeedNoclipBtn.Font = Enum.Font.GothamBold
toggleSpeedNoclipBtn.TextColor3 = Color3.new(1, 1, 1)
toggleSpeedNoclipBtn.Parent = mainFrame
Instance.new("UICorner", toggleSpeedNoclipBtn)

-- Nút Auto Cướp (khôi phục)
local toggleAutoStealBtn = Instance.new("TextButton")
toggleAutoStealBtn.Size = UDim2.new(1, -20, 0, 30)
toggleAutoStealBtn.Position = UDim2.new(0, 10, 0, 50)
toggleAutoStealBtn.BackgroundColor3 = Color3.fromRGB(255, 165, 0)
toggleAutoStealBtn.Text = "Auto Cướp: OFF"
toggleAutoStealBtn.TextScaled = true
toggleAutoStealBtn.Font = Enum.Font.GothamBold
toggleAutoStealBtn.TextColor3 = Color3.new(1, 1, 1)
toggleAutoStealBtn.Parent = mainFrame
Instance.new("UICorner", toggleAutoStealBtn)

-- Nút Cướp Nhanh (khôi phục)
local quickStealBtn = Instance.new("TextButton")
quickStealBtn.Size = UDim2.new(1, -20, 0, 30)
quickStealBtn.Position = UDim2.new(0, 10, 0, 90)
quickStealBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 0)
quickStealBtn.Text = "Cướp Nhanh"
quickStealBtn.TextScaled = true
quickStealBtn.Font = Enum.Font.GothamBold
quickStealBtn.TextColor3 = Color3.new(1, 1, 1)
quickStealBtn.Parent = mainFrame
Instance.new("UICorner", quickStealBtn)

-- Noclip logic
local originalCanCollide = {}

local function enableNoclip()
	originalCanCollide = {}
	for _, part in ipairs(character:GetDescendants()) do
		if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
			originalCanCollide[part] = part.CanCollide
			part.CanCollide = false
		end
	end
end

local function disableNoclip()
	for part, state in pairs(originalCanCollide) do
		if part and part:IsA("BasePart") then
			part.CanCollide = state
		end
	end
end

-- Tự động cập nhật speed + noclip
local function updateSpeedNoclip(state)
	speedEnabled = state
	noclipEnabled = state
	if humanoid then
		humanoid.WalkSpeed = state and walkSpeedBoost or walkSpeedDefault
		if state then
			enableNoclip()
		else
			disableNoclip()
		end
	end
	toggleSpeedNoclipBtn.Text = "Speed+Noclip: " .. (state and "ON" or "OFF")
	toggleSpeedNoclipBtn.BackgroundColor3 = state and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(255, 0, 0)
end

-- Toggle GUI visibility
toggleGuiButton.MouseButton1Click:Connect(function()
	mainFrame.Visible = not mainFrame.Visible
end)

toggleSpeedNoclipBtn.MouseButton1Click:Connect(function()
	updateSpeedNoclip(not speedEnabled)
end)

toggleAutoStealBtn.MouseButton1Click:Connect(function()
	autoStealEnabled = not autoStealEnabled
	toggleAutoStealBtn.Text = "Auto Cướp: " .. (autoStealEnabled and "ON" or "OFF")
	toggleAutoStealBtn.BackgroundColor3 = autoStealEnabled and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(255, 165, 0)
end)

local function findNearestStealableTarget()
	local closest, minDist = nil, stealRange + 1
	local pos = hrp and hrp.Position or Vector3.zero
	for _, obj in pairs(Workspace:GetDescendants()) do
		if obj:IsA("BasePart") and obj.Name == "StealableItem" then
			local dist = (obj.Position - pos).Magnitude
			if dist < minDist then
				minDist, closest = dist, obj
			end
		end
	end
	return closest
end

-- Hàm thực hiện hành động cướp với mô phỏng "giữ nút"
local function performStealAction(target)
	local remote = ReplicatedStorage:FindFirstChild("StealPet", true)
	if remote and remote:IsA("RemoteEvent") then
		local startTime = tick()
		print("Bắt đầu mô phỏng giữ nút cướp pet...")
		while tick() - startTime < stealHoldDuration do
			-- Gửi tín hiệu liên tục để mô phỏng giữ nút
			remote:FireServer(target)
			-- print("Đã gửi tín hiệu cướp:", target.Name) -- Bật dòng này để xem từng tín hiệu
			task.wait(stealSignalInterval)
		end
		print(string.format("Đã mô phỏng giữ nút cướp pet trong %.2f giây cho: %s", stealHoldDuration, target.Name))
	else
		warn("Lỗi: RemoteEvent 'StealPet' không tìm thấy hoặc không phải là RemoteEvent. Không thể thực hiện cướp.")
	end
end

-- Sự kiện click cho nút Cướp Nhanh (vẫn chỉ thực hiện một lần giữ)
quickStealBtn.MouseButton1Click:Connect(function()
	if tick() - lastStealAttemptTime < stealActionCooldown then return end -- Sử dụng cooldown toàn bộ
	local target = findNearestStealableTarget()
	if target then
		performStealAction(target)
		lastStealAttemptTime = tick()
	else
		print("Không tìm thấy mục tiêu 'StealableItem' trong phạm vi.")
	end
end)

-- Vòng lặp chính cho Auto Cướp
spawn(function()
	while true do
		if autoStealEnabled then
			if tick() - lastStealAttemptTime >= stealActionCooldown then
				local target = findNearestStealableTarget()
				if target then
					performStealAction(target)
					lastStealAttemptTime = tick() -- Cập nhật thời gian sau khi hoàn thành một chu trình cướp
				else
					-- print("Auto Cướp: Không tìm thấy mục tiêu 'StealableItem'.") -- Có thể bật để debug
				end
			end
		end
		task.wait(0.1) -- Kiểm tra mỗi 0.1 giây để tìm mục tiêu hoặc chờ cooldown
	end
end)

-- Khi nhân vật respawn
player.CharacterAdded:Connect(function(char)
	character = char
	humanoid = char:WaitForChild("Humanoid")
	hrp = char:WaitForChild("HumanoidRootPart")
	updateSpeedNoclip(speedEnabled)
end)

-- AntiKick
local success, mt = pcall(function() return getrawmetatable(game) end)
if success and mt then
	setreadonly(mt, false)
	local oldNamecall = mt.__namecall
	mt.__namecall = newcclosure(function(self, ...)
		if getnamecallmethod() == "Kick" then
			warn("Blocked Kick attempt.")
			return
		end
		return oldNamecall(self, ...)
	end)
	setreadonly(mt, true)
else
	warn("Không thể chặn Kick (__namecall)")
end
