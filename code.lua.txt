-- Script by Long Dzz - All in one KRNL compatible
-- Auto Create RemoteEvent + Server-side + Client-side GUI/Tool features

--// SERVICES
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer

--// CONFIG
local ATTACK_RADIUS = 25
local DAMAGE = 25
local FAST_COOLDOWN = 0.1
local NORMAL_COOLDOWN = 0.5

--// REMOTE SETUP
local attackEvent = ReplicatedStorage:FindFirstChild("RangedAttackEvent")
if not attackEvent then
    attackEvent = Instance.new("RemoteEvent", ReplicatedStorage)
    attackEvent.Name = "RangedAttackEvent"
end

--// SERVER FUNCTION
if not getgenv()._hookedServer then
    getgenv()._hookedServer = true

    local lastAttack = {}

    attackEvent.OnServerEvent:Connect(function(player, targetPosition)
        local now = tick()
        if lastAttack[player] and now - lastAttack[player] < FAST_COOLDOWN then return end
        lastAttack[player] = now

        local char = player.Character
        if not char or not char:FindFirstChild("HumanoidRootPart") then return end
        local root = char.HumanoidRootPart

        if (targetPosition - root.Position).Magnitude > 50 then return end -- Giới hạn khoảng cách

        local params = OverlapParams.new()
        params.FilterDescendantsInstances = {char}
        params.FilterType = Enum.RaycastFilterType.Exclude

        local boxSize = Vector3.new(ATTACK_RADIUS * 2, ATTACK_RADIUS * 2, ATTACK_RADIUS * 2)
        local boxCFrame = CFrame.new(targetPosition)

        local parts = workspace:GetPartBoundsInBox(boxCFrame, boxSize, params)

        for _, part in pairs(parts) do
            local model = part:FindFirstAncestorOfClass("Model")
            if model and model ~= char then
                local hum = model:FindFirstChildOfClass("Humanoid")
                if hum and hum.Health > 0 then
                    hum:TakeDamage(DAMAGE)
                end
            end
        end
    end)
end

--// CLIENT SCRIPT
local FastAttack, AoEEnabled, AimEnabled, SpeedEnabled, NoClipEnabled, FlyEnabled, ESPEnabled, ShowCircle = false, false, false, false, false, false, false, false
local canAttack = true

local function getNearestTarget()
    local char = player.Character
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return end

    local closest, dist = nil, math.huge

    for _, model in pairs(workspace:GetDescendants()) do
        if model:IsA("Model") and model ~= char then
            local hum = model:FindFirstChildOfClass("Humanoid")
            local hrp = model:FindFirstChild("HumanoidRootPart")
            if hum and hum.Health > 0 and hrp then
                local d = (hrp.Position - root.Position).Magnitude
                if d < ATTACK_RADIUS and d < dist then
                    dist = d
                    closest = hrp
                end
            end
        end
    end
    return closest
end

local function attack()
    if not AoEEnabled or not canAttack then return end
    canAttack = false

    local char = player.Character
    if not char then canAttack = true return end
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then canAttack = true return end

    local targetPos = root.Position
    if AimEnabled then
        local target = getNearestTarget()
        if target then
            targetPos = target.Position
        end
    end

    attackEvent:FireServer(targetPos)
    task.wait(FastAttack and FAST_COOLDOWN or NORMAL_COOLDOWN)
    canAttack = true
end

-- Tool auto fire on activation
local tool = Instance.new("Tool", player.Backpack)
tool.RequiresHandle = false
tool.Name = "RangedTool"
tool.Activated:Connect(attack)

UIS.TouchTap:Connect(function(_, gp)
    if not gp and tool.Parent == player.Character then
        tool:Activate()
    end
end)

-- Speed
local function updateSpeed()
    local hum = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
    if hum then
        hum.WalkSpeed = SpeedEnabled and 32 or 16
    end
end

player.CharacterAdded:Connect(function()
    task.wait(0.1) -- Đợi nhân vật load xong
    updateSpeed()
end)

updateSpeed()

-- NoClip
RunService.Stepped:Connect(function()
    if NoClipEnabled then
        local char = player.Character
        if char then
            for _, part in pairs(char:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                end
            end
        end
    end
end)

-- Fly (6 chiều)
local flyBodyGyro, flyBodyVelocity
local flySpeed = 50
local flying = false

local function toggleFly(state)
    local char = player.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    flying = state

    if state then
        flyBodyGyro = Instance.new("BodyGyro", hrp)
        flyBodyGyro.P = 9e4
        flyBodyGyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
        flyBodyGyro.CFrame = hrp.CFrame

        flyBodyVelocity = Instance.new("BodyVelocity", hrp)
        flyBodyVelocity.MaxForce = Vector3.new(9e9, 9e9, 9e9)
        flyBodyVelocity.Velocity = Vector3.new(0,0,0)
    else
        if flyBodyGyro then flyBodyGyro:Destroy() flyBodyGyro = nil end
        if flyBodyVelocity then flyBodyVelocity:Destroy() flyBodyVelocity = nil end
    end
end

RunService.RenderStepped:Connect(function()
    if flying and flyBodyVelocity and flyBodyGyro then
        local char = player.Character
        if not char then return end
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hrp then return end

        flyBodyGyro.CFrame = workspace.CurrentCamera.CFrame

        local direction = Vector3.new()
        if UIS:IsKeyDown(Enum.KeyCode.W) then
            direction = direction + workspace.CurrentCamera.CFrame.LookVector
        end
        if UIS:IsKeyDown(Enum.KeyCode.S) then
            direction = direction - workspace.CurrentCamera.CFrame.LookVector
        end
        if UIS:IsKeyDown(Enum.KeyCode.A) then
            direction = direction - workspace.CurrentCamera.CFrame.RightVector
        end
        if UIS:IsKeyDown(Enum.KeyCode.D) then
            direction = direction + workspace.CurrentCamera.CFrame.RightVector
        end
        if UIS:IsKeyDown(Enum.KeyCode.Space) then
            direction = direction + Vector3.new(0,1,0)
        end
        if UIS:IsKeyDown(Enum.KeyCode.LeftControl) then
            direction = direction - Vector3.new(0,1,0)
        end

        if direction.Magnitude > 0 then
            direction = direction.Unit
            flyBodyVelocity.Velocity = direction * flySpeed
        else
            flyBodyVelocity.Velocity = Vector3.new(0,0,0)
        end
    end
end)

-- ESP
local function toggleESP(state)
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") and obj:FindFirstChildOfClass("Humanoid") and obj:FindFirstChild("HumanoidRootPart") then
            local highlight = obj:FindFirstChildOfClass("Highlight")
            if state then
                if not highlight then
                    local h = Instance.new("Highlight", obj)
                    h.FillColor = Color3.new(1, 0, 0)
                    h.OutlineColor = Color3.new(1, 1, 1)
                end
            else
                if highlight then highlight:Destroy() end
            end
        end
    end
end

-- Vòng tròn thể hiện vùng đánh
local circlePart = Instance.new("Part")
circlePart.Name = "AttackRadiusCircle"
circlePart.Anchored = true
circlePart.CanCollide = false
circlePart.Transparency = 0.5
circlePart.Size = Vector3.new(ATTACK_RADIUS*2, 0.2, ATTACK_RADIUS*2)
circlePart.Material = Enum.Material.Neon
circlePart.Color = Color3.fromRGB(0, 170, 255)
circlePart.Parent = workspace
circlePart.CFrame = CFrame.new(0, -1000, 0) -- ban đầu ẩn ở dưới map

local function updateCircle()
    local char = player.Character
    if char and ShowCircle then
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if hrp then
            circlePart.CFrame = CFrame.new(hrp.Position.X, hrp.Position.Y - 1.5, hrp.Position.Z) * CFrame.Angles(math.rad(90),0,0)
            circlePart.Transparency = 0.5
            circlePart.Parent = workspace
        else
            circlePart.Parent = nil
        end
    else
        circlePart.Parent = nil
    end
end

RunService.RenderStepped:Connect(updateCircle)

-- GUI
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.ResetOnSpawn = false

-- Rainbow Title
local title = Instance.new("TextLabel", gui)
title.Size = UDim2.new(0, 250, 0, 35)
title.Position = UDim2.new(0, 10, 0, 10)
title.BackgroundTransparency = 1
title.Text = "Script by: Long Dzz"
title.TextColor3 = Color3.new(1,0,1)
title.Font = Enum.Font.GothamBold
title.TextSize = 22

spawn(function()
    while true do
        for i=0,1,0.01 do
            title.TextColor3 = Color3.fromHSV(i,1,1)
            task.wait(0.03)
        end
    end
end)

local function createToggle(text, pos, color, callback)
    local frame = Instance.new("Frame", gui)
    frame.Size = UDim2.new(0, 140, 0, 30)
    frame.Position = pos
    frame.BackgroundColor3 = color
    frame.BorderSizePixel = 0
    frame.BackgroundTransparency = 0.15
    frame.AutoButtonColor = false

    local label = Instance.new("TextLabel", frame)
    label.Size = UDim2.new(0, 120, 0, 30)
    label.Position = UDim2.new(0, 10, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.new(1,1,1)
    label.Font = Enum.Font.GothamBold
    label.TextSize = 18
    label.TextXAlignment = Enum.TextXAlignment.Left

    local button = Instance.new("TextButton", frame)
    button.Size = UDim2.new(0, 25, 0, 25)
    button.Position = UDim2.new(1, -30, 0, 2)
    button.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
    button.BorderSizePixel = 0
    button.Text = ""
    button.AutoButtonColor = false

    local toggled = false

    local function updateButton()
        if toggled then
            button.BackgroundColor3 = Color3.new(0, 1, 0)
        else
            button.BackgroundColor3 = Color3.new(1, 0, 0)
        end
    end

    button.MouseButton1Click:Connect(function()
        toggled = not toggled
        updateButton()
        callback(toggled)
    end)

    updateButton()
end

-- Tạo Toggle GUI
createToggle("Tăng tốc x2", UDim2.new(0, 10, 0, 60), Color3.fromRGB(255, 0, 255), function(s)
    SpeedEnabled = s
    updateSpeed()
end)

createToggle("Bật tấn công nhanh", UDim2.new(0, 10, 0, 100), Color3.fromRGB(255, 0, 0), function(s)
    FastAttack = s
end)

createToggle("Bật AoE", UDim2.new(0, 10, 0, 140), Color3.fromRGB(0, 255, 255), function(s)
    AoEEnabled = s
end)

createToggle("Tự nhắm mục tiêu", UDim2.new(0, 10, 0, 180), Color3.fromRGB(255, 255, 0), function(s)
    AimEnabled = s
end)

createToggle("Bật NoClip", UDim2.new(0, 10, 0, 220), Color3.fromRGB(0, 255, 0), function(s)
    NoClipEnabled = s
end)

createToggle("Bật bay", UDim2.new(0, 10, 0, 260), Color3.fromRGB(0, 170, 255), function(s)
    FlyEnabled = s
    toggleFly(s)
end)

createToggle("Bật ESP", UDim2.new(0, 10, 0, 300), Color3.fromRGB(255, 170, 0), function(s)
    ESPEnabled = s
    toggleESP(s)
end)

createToggle("Hiện vòng tròn đánh", UDim2.new(0, 10, 0, 340), Color3.fromRGB(0, 170, 255), function(s)
    ShowCircle = s
end)
