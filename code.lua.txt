local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local player = Players.LocalPlayer
local UIS = game:GetService("UserInputService")

local walkSpeedDefault = 16
local walkSpeedBoost = 28
local noclipEnabled = false
local speedEnabled = false
local autoStealEnabled = false

local stealRange = 15
local lastStealTime = 0
local stealCooldown = 0.5

local character
local humanoid
local hrp

-- Hàm lấy Humanoid và HumanoidRootPart với timeout 5 giây
local function getCharacterParts(char)
    local humanoid = char:WaitForChild("Humanoid", 5)
    local hrp = char:WaitForChild("HumanoidRootPart", 5)
    if humanoid and hrp then
        return humanoid, hrp
    else
        warn("Thiếu Humanoid hoặc HumanoidRootPart trong 5 giây")
        return nil, nil
    end
end

-- Khởi tạo character và parts
character = player.Character or player.CharacterAdded:Wait()
humanoid, hrp = getCharacterParts(character)

-- GUI setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "SysCoreUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- TextLabel "script by Long dzz" luôn hiện ở góc trên đầu màn hình
local creditText = Instance.new("TextLabel")
creditText.Size = UDim2.new(0, 150, 0, 25)
creditText.Position = UDim2.new(0, 10, 0, 10)
creditText.BackgroundTransparency = 1
creditText.Text = "script by Long dzz"
creditText.TextColor3 = Color3.new(1, 1, 1)
creditText.Font = Enum.Font.Gotham
creditText.TextScaled = true
creditText.Parent = screenGui

local toggleGuiButton = Instance.new("TextButton")
toggleGuiButton.Size = UDim2.new(0, 40, 0, 40)
toggleGuiButton.Position = UDim2.new(0, 10, 0, 45) -- Đẩy xuống dưới creditText
toggleGuiButton.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
toggleGuiButton.Text = "+"
toggleGuiButton.TextScaled = true
toggleGuiButton.TextColor3 = Color3.new(1, 1, 1)
toggleGuiButton.BorderSizePixel = 0
toggleGuiButton.AutoButtonColor = false
toggleGuiButton.Font = Enum.Font.GothamBlack
toggleGuiButton.Parent = screenGui
Instance.new("UICorner", toggleGuiButton)

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 160, 0, 170)
mainFrame.Position = UDim2.new(0, 60, 0, 45)
mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
mainFrame.Visible = false
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame)

local toggleSpeedNoclipBtn = Instance.new("TextButton")
toggleSpeedNoclipBtn.Size = UDim2.new(1, -20, 0, 30)
toggleSpeedNoclipBtn.Position = UDim2.new(0, 10, 0, 25)
toggleSpeedNoclipBtn.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
toggleSpeedNoclipBtn.Text = "Speed+Noclip: OFF"
toggleSpeedNoclipBtn.TextScaled = true
toggleSpeedNoclipBtn.Font = Enum.Font.GothamBold
toggleSpeedNoclipBtn.TextColor3 = Color3.new(1, 1, 1)
toggleSpeedNoclipBtn.Parent = mainFrame
Instance.new("UICorner", toggleSpeedNoclipBtn)

local toggleAutoStealBtn = Instance.new("TextButton")
toggleAutoStealBtn.Size = UDim2.new(1, -20, 0, 30)
toggleAutoStealBtn.Position = UDim2.new(0, 10, 0, 65)
toggleAutoStealBtn.BackgroundColor3 = Color3.fromRGB(255, 165, 0)
toggleAutoStealBtn.Text = "Auto Cướp: OFF"
toggleAutoStealBtn.TextScaled = true
toggleAutoStealBtn.Font = Enum.Font.GothamBold
toggleAutoStealBtn.TextColor3 = Color3.new(1, 1, 1)
toggleAutoStealBtn.Parent = mainFrame
Instance.new("UICorner", toggleAutoStealBtn)

local quickStealBtn = Instance.new("TextButton")
quickStealBtn.Size = UDim2.new(1, -20, 0, 30)
quickStealBtn.Position = UDim2.new(0, 10, 0, 105)
quickStealBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 0)
quickStealBtn.Text = "Cướp Nhanh"
quickStealBtn.TextScaled = true
quickStealBtn.Font = Enum.Font.GothamBold
quickStealBtn.TextColor3 = Color3.new(1, 1, 1)
quickStealBtn.Parent = mainFrame
Instance.new("UICorner", quickStealBtn)

local fakeExitBtn = Instance.new("TextButton")
fakeExitBtn.Size = UDim2.new(1, -20, 0, 30)
fakeExitBtn.Position = UDim2.new(0, 10, 0, 145)
fakeExitBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
fakeExitBtn.Text = "Thoát giả"
fakeExitBtn.TextScaled = true
fakeExitBtn.Font = Enum.Font.Gotham
fakeExitBtn.TextColor3 = Color3.fromRGB(1, 1, 1)
fakeExitBtn.Parent = mainFrame
Instance.new("UICorner", fakeExitBtn)

-- Noclip helpers
local originalCanCollide = {}

local function enableNoclip()
    if not character then return end
    originalCanCollide = {}
    for _, part in ipairs(character:GetDescendants()) do
        if part:IsA("BasePart") and part.Name ~= "HumanoidRootPart" then
            originalCanCollide[part] = part.CanCollide
            part.CanCollide = false
        end
    end
end

local function disableNoclip()
    for part, collide in pairs(originalCanCollide) do
        if part and part:IsA("BasePart") then
            part.CanCollide = collide
        end
    end
    originalCanCollide = {}
end

local function updateSpeedNoclip(state)
    noclipEnabled = state
    speedEnabled = state

    if humanoid then
        if speedEnabled then
            humanoid.WalkSpeed = walkSpeedBoost
            enableNoclip()
            toggleSpeedNoclipBtn.Text = "Speed+Noclip: ON"
            toggleSpeedNoclipBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
        else
            humanoid.WalkSpeed = walkSpeedDefault
            disableNoclip()
            toggleSpeedNoclipBtn.Text = "Speed+Noclip: OFF"
            toggleSpeedNoclipBtn.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
        end
    end
end

-- Nút hiện/ẩn GUI chính
toggleGuiButton.MouseButton1Click:Connect(function()
    mainFrame.Visible = not mainFrame.Visible
end)

-- Bật/tắt Speed + Noclip
toggleSpeedNoclipBtn.MouseButton1Click:Connect(function()
    updateSpeedNoclip(not speedEnabled)
end)

-- Tìm mục tiêu cướp gần nhất
local function findNearestStealableTarget()
    local nearestTarget = nil
    local shortestDistance = stealRange + 1
    local playerPos = hrp and hrp.Position or Vector3.new()

    for _, obj in pairs(Workspace:GetDescendants()) do
        if obj:IsA("BasePart") and obj.Name == "StealableItem" then -- Thay tên "StealableItem" nếu cần
            local dist = (obj.Position - playerPos).Magnitude
            if dist <= stealRange and dist < shortestDistance then
                shortestDistance = dist
                nearestTarget = obj
            end
        end
    end
    return nearestTarget
end

-- Lấy RemoteEvent "StealPet" trong ReplicatedStorage
local function getStealRemote()
    local remote = ReplicatedStorage:FindFirstChild("StealPet", true)
    if remote and remote:IsA("RemoteEvent") then
        return remote
    end
    warn("Không tìm thấy RemoteEvent 'StealPet'")
    return nil
end

-- Thử cướp mục tiêu
local function trySteal()
    if tick() - lastStealTime < stealCooldown then return end
    local target = findNearestStealableTarget()
    if target then
        local stealRemote = getStealRemote()
        if stealRemote then
            stealRemote:FireServer(target)
            print("Đã gửi yêu cầu cướp:", target.Name)
            lastStealTime = tick()
        end
    else
        warn("Không tìm thấy mục tiêu cướp trong tầm")
    end
end

-- Nút cướp nhanh
quickStealBtn.MouseButton1Click:Connect(trySteal)

-- Bật/tắt Auto Cướp
toggleAutoStealBtn.MouseButton1Click:Connect(function()
    autoStealEnabled = not autoStealEnabled
    if autoStealEnabled then
        toggleAutoStealBtn.Text = "Auto Cướp: ON"
        toggleAutoStealBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
    else
        toggleAutoStealBtn.Text = "Auto Cướp: OFF"
        toggleAutoStealBtn.BackgroundColor3 = Color3.fromRGB(255, 165, 0)
    end
end)

-- Vòng lặp auto cướp
spawn(function()
    while true do
        if autoStealEnabled then
            trySteal()
        end
        task.wait(stealCooldown)
    end
end)

-- Fake Exit (ẩn GUI)
local function activateFakeExit()
    mainFrame.Visible = false
    toggleGuiButton.Visible = false
    warn("AntiBan: Fake quit đã kích hoạt tự động.")
end

fakeExitBtn.MouseButton1Click:Connect(activateFakeExit)
activateFakeExit() -- Tự động kích hoạt khi script chạy

-- Cập nhật lại khi nhân vật respawn
player.CharacterAdded:Connect(function(char)
    character = char
    humanoid, hrp = getCharacterParts(char)
    if speedEnabled then
        if humanoid then humanoid.WalkSpeed = walkSpeedBoost end
        enableNoclip()
    else
        if humanoid then humanoid.WalkSpeed = walkSpeedDefault end
        disableNoclip()
    end
end)

-- Basic AntiKick
local success, mt = pcall(function() return getrawmetatable(game) end)
if success and mt then
    setreadonly(mt, false)
    local oldNamecall = mt.__namecall
    mt.__namecall = newcclosure(function(self, ...)
        local method = getnamecallmethod()
        if method == "Kick" then
            warn("Blocked Kick attempt.")
            return nil
        end
        return oldNamecall(self, ...)
    end)
    setreadonly(mt, true)
else
    warn("Không thể override __namecall để chặn Kick")
end
