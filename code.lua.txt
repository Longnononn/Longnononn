-- Script by Long Dzz - Client-side features for Fluxus

-- Chỉ tập trung vào các tính năng chạy ở phía máy khách

--// SERVICES

local Players = game:GetService("Players")

local ReplicatedStorage = game:GetService("ReplicatedStorage")

local RunService = game:GetService("RunService")

local UIS = game:GetService("UserInputService")

local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer
--// CONFIG (Client-side)

local ATTACK_RADIUS = 25 -- Chỉ sử dụng cho logic tìm mục tiêu gần nhất ở client
--// REMOTE SETUP (Client-side)

local attackEvent = ReplicatedStorage:FindFirstChild("RangedAttackEvent")

if not attackEvent then
    attackEvent = Instance.new("RemoteEvent", ReplicatedStorage)
    attackEvent.Name = "RangedAttackEvent"
end

--// CLIENT SCRIPT

local FastAttack, AoEEnabled, AimEnabled, SpeedEnabled, NoClipEnabled, FlyEnabled, ESPEnabled = false, false, false, false, false, false, false
local menuVisible = true -- Biến theo dõi trạng thái menu
local canAttack = true
local function getNearestTarget()
    local char = player.Character
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return end
    local closest, dist = nil, math.huge
    for _, model in pairs(workspace:GetDescendants()) do
        if model:IsA("Model") and model ~= char then
            local hum = model:FindFirstChildOfClass("Humanoid")
            local hrp = model:FindFirstChild("HumanoidRootPart")
            if hum and hum.Health > 0 and hrp then
                local d = (hrp.Position - root.Position).Magnitude
                if d < ATTACK_RADIUS and d < dist then
                    dist = d
                    closest = hrp
                end
            end
        end
    end
    return closest
end

local function attack()
    if not AoEEnabled or not canAttack then return end
    canAttack = false
    local char = player.Character
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return end

    local targetPos = root.Position
    if AimEnabled then
        local target = getNearestTarget()
        if target then
            targetPos = target.Position
        end
    end

    -- Gửi yêu cầu tấn công đến máy chủ
    if attackEvent then
        attackEvent:FireServer(targetPos)
    end
    task.wait(FastAttack and FAST_COOLDOWN or NORMAL_COOLDOWN)
    canAttack = true
end

-- Tool auto fire on activation
local tool = Instance.new("Tool", player.Backpack)
tool.RequiresHandle = false
tool.Name = "RangedTool"
tool.Activated:Connect(attack)
UIS.TouchTap:Connect(function(_, gp)
    if not gp and tool.Parent == player.Character then
        tool:Activate()
    end
end)

-- Speed
local function updateSpeed()
    local hum = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
    if hum then
        hum.WalkSpeed = SpeedEnabled and 32 or 16
    end
end
player.CharacterAdded:Connect(updateSpeed)

-- NoClip
RunService.Stepped:Connect(function()
    if NoClipEnabled then
        local char = player.Character
        if char then
            for _, part in pairs(char:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                end
            end
        end
    end
end)

-- Fly
local flyBodyGyro, flyBodyVelocity
local function toggleFly(state)
    local char = player.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    if state then
        flyBodyGyro = Instance.new("BodyGyro", hrp)
        flyBodyGyro.P = 9e4
        flyBodyGyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
        flyBodyGyro.CFrame = hrp.CFrame

        flyBodyVelocity = Instance.new("BodyVelocity", hrp)
        flyBodyVelocity.Velocity = Vector3.zero
        flyBodyVelocity.MaxForce = Vector3.new(9e9, 9e9, 9e9)
    else
        if flyBodyGyro then flyBodyGyro:Destroy() end
        if flyBodyVelocity then flyBodyVelocity:Destroy() end
    end
end
RunService.RenderStepped:Connect(function()
    if FlyEnabled and flyBodyVelocity and UIS:IsKeyDown(Enum.KeyCode.Space) then
        flyBodyVelocity.Velocity = Vector3.new(0, 50, 0)
    elseif FlyEnabled and flyBodyVelocity then
        flyBodyVelocity.Velocity = Vector3.zero
    end
end)

-- ESP
local function toggleESP(state)
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") and obj:FindFirstChildOfClass("Humanoid") and obj:FindFirstChild("HumanoidRootPart") then
            local highlight = obj:FindFirstChildOfClass("Highlight")
            if state then
                if not highlight then
                    local h = Instance.new("Highlight", obj)
                    h.FillColor = Color3.new(1, 0, 0)
                    h.OutlineColor = Color3.new(1, 1, 1)
                end
            else
                if highlight then highlight:Destroy() end
            end
        end
    end
end

-- GUI

local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.ResetOnSpawn = false

-- Rainbow Title
local title = Instance.new("TextLabel", gui)
title.Size = UDim2.new(0, 250, 0, 35)
title.Position = UDim2.new(0, 10, 0, 10)
title.BackgroundTransparency = 1
title.Text = "Script by: Long Dzz (Client)" -- Đánh dấu rõ ràng là client-side
title.Font = Enum.Font.FredokaOne
title.TextScaled = true
title.TextColor3 = Color3.new(1, 1, 1)
task.spawn(function()
    while true do
        local t = tick()
        title.TextColor3 = Color3.fromRGB(
            math.floor(math.abs(math.sin(t)) * 255),
            math.floor(math.abs(math.sin(t + 2)) * 255),
            math.floor(math.abs(math.sin(t + 4)) * 255)
        )
        task.wait(0.1)
    end
end)

-- Frame chứa các nút chức năng
local functionFrame = Instance.new("Frame", gui)
functionFrame.Size = UDim2.new(0, 260, 0, 255)
functionFrame.Position = UDim2.new(0, 10, 0, 50)
functionFrame.BackgroundTransparency = 1
functionFrame.BorderSizePixel = 0

-- Button Generator (sử dụng functionFrame làm Parent)
local function createToggle(name, pos, color, callback)
    local btn = Instance.new("TextButton", functionFrame) -- Thay đổi parent thành functionFrame
    btn.Size = UDim2.new(0, 120, 0, 40) -- Điều chỉnh kích thước nút nếu cần
    btn.Position = pos
    btn.Text = name
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 14
    btn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.BorderSizePixel = 0
    local state = false
    btn.MouseButton1Click:Connect(function()
        state = not state
        TweenService:Create(btn, TweenInfo.new(0.3), {BackgroundColor3 = state and color or Color3.fromRGB(40, 40, 40)}):Play()
        callback(state)
    end)
end

-- Nút bật tắt menu
local toggleMenuButton = Instance.new("TextButton", gui)
toggleMenuButton.Size = UDim2.new(0, 100, 0, 30)
toggleMenuButton.Position = UDim2.new(0, 270, 0, 15)
toggleMenuButton.Text = "Bật/Tắt Menu"
toggleMenuButton.Font = Enum.Font.GothamBold
toggleMenuButton.TextSize = 12
toggleMenuButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
toggleMenuButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleMenuButton.BorderSizePixel = 0

toggleMenuButton.MouseButton1Click:Connect(function()
    menuVisible = not menuVisible
    functionFrame.Visible = menuVisible
end)

-- Add GUI toggles (với vị trí đã được điều chỉnh cho Frame)
createToggle("Đánh nhanh", UDim2.new(0, 10, 0, 10), Color3.fromRGB(0, 255, 0), function(s) FastAttack = s end)
createToggle("Đánh tầm xa", UDim2.new(0, 10, 0, 60), Color3.fromRGB(0, 170, 255), function(s) AoEEnabled = s end)
createToggle("Aim gần nhất", UDim2.new(0, 10, 0, 110), Color3.fromRGB(255, 170, 0), function(s) AimEnabled = s end)
createToggle("Tăng tốc x2", UDim2.new(0, 130, 0, 10), Color3.fromRGB(255, 0, 255), function(s) SpeedEnabled = s updateSpeed() end)
createToggle("Xuyên tường", UDim2.new(0, 130, 0, 60), Color3.fromRGB(255, 255, 0), function(s) NoClipEnabled = s end)
createToggle("Bay", UDim2.new(0, 130, 0, 110), Color3.fromRGB(0, 255, 255), function(s) FlyEnabled = s toggleFly(s) end)
createToggle("Hiện quái", UDim2.new(0, 10, 0, 160), Color3.fromRGB(255, 0, 0), function(s) ESPEnabled = s toggleESP(s) end)

print("✅ Client-side script loaded for Fluxus!")
